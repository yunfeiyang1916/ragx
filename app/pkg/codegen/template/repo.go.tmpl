// Code generated; DO NOT EDIT

package repo

import (
	"context"
	"github.com/go-kratos/kratos/v2/log"
	"github.com/gogf/gf/v2/errors/gerror"
	"gorm.io/gen"
	"gorm.io/gen/field"
	"gorm.io/gorm"
	"ragx/app/internal/biz"
	"ragx/app/internal/biz/entity"
	"ragx/app/internal/biz/query"
	"ragx/app/pkg/cache/redis"
)

type {{.StructName}}Repo struct{
    Data  biz.Data
    DB    *gorm.DB
    Rdb   *redis.Client
    Log   *log.Helper
    GormQuery *query.Query
}

func(d *{{.StructName}}Repo) Query() *query.Query { return d.GormQuery }

// 批量创建，支持事务
func(d *{{.StructName}}Repo) BatchCreate(ctx context.Context,list []*{{.modelPackageName}}.{{.StructName}},tx ...*query.Query) ([]*{{.modelPackageName}}.{{.StructName}},error) {
    q := d.GormQuery
	if len(tx) > 0 && tx[0] != nil {
		q = tx[0]
	}
	err := q.{{.StructName}}.WithContext(ctx).Create(list...)
    if err != nil {
        return nil, gerror.Wrap(err, "")
    }
    return list, err
}

// 创建，支持事务
func(d *{{.StructName}}Repo) Create(ctx context.Context,obj *{{.modelPackageName}}.{{.StructName}},tx ...*query.Query) (*{{.modelPackageName}}.{{.StructName}},error) {
    q := d.GormQuery
	if len(tx) > 0 && tx[0] != nil {
		q = tx[0]
	}
	err := q.{{.StructName}}.WithContext(ctx).Create(obj)
    if err != nil {
        return nil, gerror.Wrap(err, "")
    }
    return obj, err
}

// 保存全部字段，支持事务
func(d *{{.StructName}}Repo) Save(ctx context.Context,obj *{{.modelPackageName}}.{{.StructName}}, tx ...*query.Query) (int64,error) {
	qu := d.GormQuery
	if len(tx) > 0 && tx[0] != nil {
		qu = tx[0]
	}
	q := qu.{{.StructName}}
	columns := []field.Expr{ {{range $field := .TableInfo.CodeFields}} {{ if not $field.PrimaryKeyArgName}} q.{{$field.GoFieldName}} ,{{end}}{{end -}} }
	res, err := q.WithContext(ctx).Where(q.ID.Eq(obj.ID)).Select(columns...).UpdateColumns(obj)
	if err != nil {
		return 0, gerror.Wrap(err, "")
	}
	return res.RowsAffected, nil
}

// 仅更新指定字段，支持表达式，表达式不能为空
func(d *{{.StructName}}Repo) Update(ctx context.Context,obj *{{.modelPackageName}}.{{.StructName}},columns ...field.Expr) (int64,error) {
	if len(columns) == 0 {
		return 0, gerror.New("no columns to update")
	}
	q := d.GormQuery.{{.StructName}}
	res, err := q.WithContext(ctx).Where(q.ID.Eq(obj.ID)).Select(columns...).UpdateColumns(obj)
	if err != nil {
		return 0, gerror.Wrap(err, "")
	}
	return res.RowsAffected,nil
}

// 支持事务，仅更新指定字段，支持表达式，表达式不能为空
func(d *{{.StructName}}Repo) UpdateWithTx(ctx context.Context,tx *query.Query,obj *{{.modelPackageName}}.{{.StructName}},columns ...field.Expr) (int64,error) {
	if len(columns) == 0 {
		return 0, gerror.New("no columns to update")
	}
	q := tx.{{.StructName}}
	res, err := q.WithContext(ctx).Where(q.ID.Eq(obj.ID)).Select(columns...).UpdateColumns(obj)
	if err != nil {
		return 0, gerror.Wrap(err, "")
	}
	return res.RowsAffected,nil
}

// 删除，支持事务
func(d *{{.StructName}}Repo) Delete(ctx context.Context,{{range $field := .TableInfo.CodeFields}} {{ if $field.PrimaryKeyArgName }} {{ toLower $field.GoFieldName}} {{ $field.GoFieldType}},{{end}}{{end -}} tx ...*query.Query) (int64,error) {
    qu := d.GormQuery
	if len(tx) > 0 && tx[0] != nil {
		qu = tx[0]
	}
	q := qu.{{.StructName}}
	res, err := q.WithContext(ctx).Where(q.ID.Eq(id)).Delete()
	if err != nil {
		return 0,gerror.Wrap(err, "")
	}
	return res.RowsAffected,nil
}

func(d *{{.StructName}}Repo) DeleteByConditions(ctx context.Context,conditions ...gen.Condition) (int64,error){
    if len(conditions) == 0 {
		return 0, gerror.New("no conditions to delete")
	}
	q := d.GormQuery.{{.StructName}}
	res, err := q.WithContext(ctx).Where(conditions...).Delete()
	if err != nil {
		return 0, gerror.Wrap(err, "")
	}
	return res.RowsAffected, nil
}

func(d *{{.StructName}}Repo) DeleteByConditionsWithTx(ctx context.Context,tx *query.Query,conditions ...gen.Condition) (int64,error){
    if len(conditions) == 0 {
		return 0, gerror.New("no conditions to delete")
	}
	q := tx.{{.StructName}}
	res, err := q.WithContext(ctx).Where(conditions...).Delete()
	if err != nil {
		return 0, gerror.Wrap(err, "")
	}
	return res.RowsAffected, nil
}

func(d *{{.StructName}}Repo) Get(ctx context.Context,{{range $field := .TableInfo.CodeFields}} {{ if $field.PrimaryKeyArgName }} {{ toLower $field.GoFieldName}} {{ $field.GoFieldType}},{{end}}{{end -}}preload ...field.RelationField) (*{{.modelPackageName}}.{{.StructName}},error){
    q := d.GormQuery.{{.StructName}}
	obj, err := q.WithContext(ctx).Where(q.ID.Eq(id)).Preload(preload...).First()
	if err != nil {
		if gerror.Is(err, gorm.ErrRecordNotFound) {
			return nil, err
		}
		return nil, gerror.Wrap(err, "")
	}
	return obj, nil
}

func(d *{{.StructName}}Repo) GetByConditions(ctx context.Context,conditions ...gen.Condition) (*{{.modelPackageName}}.{{.StructName}},error){
    if len(conditions) == 0 {
        return nil, gerror.New("no conditions to delete")
    }
    q := d.GormQuery.{{.StructName}}
    obj, err := q.WithContext(ctx).Where(conditions...).First()
    if err != nil {
        if gerror.Is(err, gorm.ErrRecordNotFound) {
            return nil, err
        }
        return nil, gerror.Wrap(err, "")
    }
    return obj, nil
}

// 支持预加载
func(d *{{.StructName}}Repo) GetByConditionsWithPreload(ctx context.Context,preload []field.RelationField,conditions ...gen.Condition) (*{{.modelPackageName}}.{{.StructName}},error){
    if len(conditions) == 0 {
        return nil, gerror.New("no conditions to delete")
    }
    q := d.GormQuery.{{.StructName}}
    obj, err := q.WithContext(ctx).Where(conditions...).Preload(preload...).First()
    if err != nil {
        if gerror.Is(err, gorm.ErrRecordNotFound) {
            return nil, err
        }
        return nil, gerror.Wrap(err, "")
    }
    return obj, nil
}

func (d *{{.StructName}}Repo) List(ctx context.Context, page *entity.PageAndOrder, conditions ...gen.Condition) ([]*entity.{{.StructName}}, int64, error) {
	q := d.GormQuery.{{.StructName}}
	where := q.WithContext(ctx).Where(conditions...)
	count, err := where.Count()
	if err != nil {
		return nil, 0, gerror.Wrap(err, "")
	}
	if count == 0 {
		return nil, 0, nil
	}
	if page != nil {
		if page.Page <= 0 {
			page.Page = 1
		}
		if page.PageSize <= 0 {
			page.PageSize = 10
		}
		if page.Order != nil {
			where = where.Order(page.Order)
		} else {
			where = where.Order(q.ID.Desc())
		}
		where = where.Preload(page.Preload...).Offset((page.Page - 1) * page.PageSize).Limit(page.PageSize)
	}
	list, err := where.Find()
	if err != nil {
		return nil, 0, gerror.Wrap(err, "")
	}
	return list, count, nil
}

// 只需要列表，不需要总数
func (d *{{.StructName}}Repo) ListWithoutCount(ctx context.Context, page *entity.PageAndOrder, conditions ...gen.Condition) ([]*entity.{{.StructName}}, error) {
	q := d.GormQuery.{{.StructName}}
	where := q.WithContext(ctx).Where(conditions...)
	if page != nil {
		if page.Page <= 0 {
			page.Page = 1
		}
		if page.PageSize <= 0 {
			page.PageSize = 10
		}
		if page.Order != nil {
			where = where.Order(page.Order)
		} else {
			where = where.Order(q.ID.Desc())
		}
		where = where.Preload(page.Preload...).Offset((page.Page - 1) * page.PageSize).Limit(page.PageSize)
	}
	list, err := where.Find()
	if err != nil {
		return nil, gerror.Wrap(err, "")
	}
	return list, nil
}

func (d *{{.StructName}}Repo) ListAll(ctx context.Context,conditions ...gen.Condition) ([]*entity.{{.StructName}}, error) {
	q := d.GormQuery.{{.StructName}}
	list, err := q.WithContext(ctx).Where(conditions...).Find()
	if err != nil {
		return nil, gerror.Wrap(err, "")
	}
	return list, nil
}

// 支持预加载
func (d *{{.StructName}}Repo) ListAllWithPreload(ctx context.Context,preload []field.RelationField,conditions ...gen.Condition) ([]*entity.{{.StructName}}, error) {
	q := d.GormQuery.{{.StructName}}
	list, err := q.WithContext(ctx).Where(conditions...).Preload(preload...).Find()
	if err != nil {
		return nil, gerror.Wrap(err, "")
	}
	return list, nil
}

func(d *{{.StructName}}Repo) Count(ctx context.Context,conditions ...gen.Condition) (int64,error){
    q := d.GormQuery.{{.StructName}}
    count, err := q.WithContext(ctx).Where(conditions...).Count()
    if err != nil {
        return 0, gerror.Wrap(err, "")
    }
    return count, nil
}




